(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[383],{43383:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return Home}});var l,n,s=i(44810),a=i(51594),o=i(24576),d=i(34484),r=i.n(d),c=i(48466),u=i(80009),p=i(79246),h=i(6288),f=i(81057),g=i(7124);i(15788);var m=i(23867),y=i.n(m);let x=new(y()).graphlib.Graph().setDefaultEdgeLabel(()=>({})),getLayoutedElements=(e,t,i)=>{x.setGraph({rankdir:i.direction});let l=document.querySelectorAll(".kvlist-node"),n=Array.from(l).reduce((e,t)=>{let i=t.id;return{...e,[i]:t.clientHeight}},{});return t.forEach(e=>x.setEdge(e.source,e.target)),e.forEach(e=>x.setNode(e.id,Object.assign(e,{width:400,height:n[e.id]||100}))),y().layout(x),{nodes:e.map(e=>{let{x:t,y:i}=x.node(e.id);return{...e,position:{x:t,y:i}}}),edges:t}};var b=i(58355),j=i(15105),k=i(83260);function KVList(e){let[t,i]=(0,o.useState)(!1),l=formatValues(e.data.data);return(0,s.jsx)("div",{className:"kvlist-node",id:e.id,children:(0,s.jsx)(a.Zb,{style:{background:"#fff"},headerStyle:{paddingTop:15,paddingBottom:15},bodyStyle:{paddingTop:0,paddingBottom:0},title:(0,s.jsxs)("h1",{children:[(0,s.jsx)(u.HH,{type:"target",position:u.Ly.Left,style:{top:30}}),(0,s.jsx)(a.J2,{visible:t,showArrow:!0,arrowPointAtCenter:!0,rePosKey:Date.now(),clickToHide:!0,closeOnEsc:!0,content:(0,s.jsxs)("div",{children:[(0,s.jsx)(b.Z,{size:"small",color:"#666"}),(0,s.jsx)(a.w5,{size:"small",data:e.data.fields.map(e=>({key:e.label,value:l[e.id]}))})]}),trigger:"custom",position:"rightTop",spacing:10,children:(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,s.jsx)("span",{children:e.data.label}),(0,s.jsx)(a.zx,{style:{marginLeft:"10px"},size:"small",icon:(0,s.jsx)(j.Z,{}),onClick:()=>i(!t)})]})})]}),children:(0,s.jsx)(a.l0,{labelPosition:"left",labelAlign:"right",initValues:l,onClickCapture:e=>{e.stopPropagation()},children:e.data.fields.filter(e=>e.type===k.fS.SingleLink||e.type===k.fS.DuplexLink).map((e,t)=>(0,s.jsxs)("div",{children:[(0,s.jsx)(a.l0.Input,{field:e.id,label:e.label,readonly:!0,trigger:"blur",style:{width:200}}),(e.type===k.fS.SingleLink||e.type===k.fS.DuplexLink)&&(0,s.jsx)(u.HH,{id:e.id,type:"source",style:{top:56*t+52+29},position:u.Ly.Right})]},e.id))})})})}function formatValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=e.reduce((e,t)=>(e[t.field]=t.value,e),{});return t}var v=i(70146),w=i(11433);let C={kvlist:KVList},LayoutFlow=e=>{let{initialNodes:t=[],initialEdges:i=[],fullscreen:l=!1}=e,{fitView:n}=(0,u._K)(),[a,d,r]=(0,u.Rr)(t),[c,m,y]=(0,u.ll)(i),x=(0,o.useCallback)(()=>{let{nodes:e,edges:t}=getLayoutedElements(a,c,{direction:"LR"});console.log(e,t),d([...e]),m([...t]),window.requestAnimationFrame(()=>{n()})},[a,c]),b=(0,o.useCallback)(e=>m(t=>(0,u.Z_)(e,t)),[m]),j=(0,o.useCallback)(e=>{x(),setTimeout(()=>{e.fitView({maxZoom:.9})})},[x]),k=(0,o.useCallback)(()=>{let e=open("/","_block");e&&(e.options=()=>({initialEdges:i,initialNodes:t,fullscreen:!0}))},[i,t]),L=(0,o.useCallback)(()=>{},[x]);return(0,s.jsxs)(u.x$,{nodeTypes:C,attributionPosition:"bottom-left",nodes:a,edges:c,onNodesChange:r,onEdgesChange:y,onConnect:b,onInit:j,minZoom:.1,onMoveEnd:L,children:[(0,s.jsxs)(p.Z,{children:[!l&&(0,s.jsx)(p.B,{onClick:()=>k(),children:(0,s.jsx)(v.Z,{})}),(0,s.jsx)(p.B,{onClick:()=>open("https://zhuanlan.zhihu.com/p/670722277"),children:(0,s.jsx)(w.Z,{})})]}),l&&(0,s.jsx)(h.a,{}),(0,s.jsx)(f.M,{}),(0,s.jsx)(g.A,{variant:g.T.Dots,gap:12,size:1})]})};function trans(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[],i=[];for(let l=0;l<e.length;l++){let n=e[l],s={id:n.id,type:"kvlist",position:{x:0,y:0},data:{start:0===l,end:l===e.length-1,label:n.label,fields:n.fields,data:n.data}};t.push(s);for(let e=0;e<n.fields.length;e++){let t=n.fields[e];if(t.type===k.fS.SingleLink||t.type===k.fS.DuplexLink){let e=t.property.tableId,l={id:n.id+"-"+t.id+"-"+e,sourceHandle:t.id,source:n.id,target:e};i.push(l)}}}return[t,i]}var L=i(94255),S=i(77675);let _=(null===(n=window)||void 0===n?void 0:null===(l=n.options)||void 0===l?void 0:l.call(n))||{},T=(0,L.Z)();async function fetchTables(){let e=await k.ws.base.getTableList();return await bsTableTrans(e)}async function bsTableTrans(e){let t=[];for(let i=0;i<e.length;i++){let l=e[i],n=await l.getName(),s=await l.getFieldList().then(e=>Promise.all(e.map(e=>e.getMeta()))),a=s.find(e=>e.isPrimary);t.push({id:l.id,label:n,primary:null==a?void 0:a.id,meta:l,fields:s.map(e=>({id:e.id,label:e.name,type:e.type,property:e.property,meta:e})),data:s.map(e=>({field:e.id,value:k.fS[e.type]}))})}return t}function Home(){let[e]=(0,c.$G)(),[t,i]=(0,o.useState)({}),[l,n]=(0,o.useState)(!0),[d,p]=(0,o.useState)(!1),[h,f]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{if(_.fullscreen){f(!0),n(!0),i(_),n(!1),p(!0);return}return fetchTables().then(e=>{n(!0),p(!1),console.log({tables:e});let[t,l]=trans(e);console.log({initialNodes:t,initialEdges:l}),i({initialNodes:t,initialEdges:l}),p(!0),setTimeout(()=>{n(!1)},100)}),()=>{}},[]),(0,s.jsxs)("main",{className:r().main,style:{width:"100vw",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center"},children:[h?d&&(0,s.jsx)(u.tV,{children:(0,s.jsx)(LayoutFlow,{...t})}):(0,s.jsx)(a.HY,{image:(0,s.jsx)(S.xs,{style:{width:150,height:150}}),darkModeImage:(0,s.jsx)(S.m3,{style:{width:150,height:150}}),description:e("empty-tip")}),l&&(0,s.jsx)("div",{style:{width:"100%",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#fff",position:"fixed",top:0,left:0,zIndex:100},children:(0,s.jsx)(a.yC,{size:"large"})})]})}_.fullscreen||k.ws.base.onSelectionChange(async e=>{T.emit("change-record",e)})},34484:function(e){e.exports={main:"Home_main__ElU3j",h4:"Home_h4__4GCIr",code:"Home_code__ESbU9"}}}]);
//# sourceMappingURL=383.9c44b1003d074977.js.map